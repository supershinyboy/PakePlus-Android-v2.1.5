import{p as T,K as B}from"./index-DeoopqlN.js";const D=T(()=>{var t;return((t=B.selectedTokenRoleInfo)==null?void 0:t.role)||1}),O=a=>{var m,o,i,n,r;if(!a)return null;if(Array.isArray(a)){const u=a[0];return(u==null?void 0:u.roleId)||(u==null?void 0:u.id)||(u==null?void 0:u.targetId)}const t=((m=a==null?void 0:a.rankList)==null?void 0:m[0])||((o=a==null?void 0:a.roleList)==null?void 0:o[0])||((i=a==null?void 0:a.targets)==null?void 0:i[0])||((n=a==null?void 0:a.targetList)==null?void 0:n[0])||((r=a==null?void 0:a.list)==null?void 0:r[0]);if(t){if(t.roleId)return t.roleId;if(t.id)return t.id;if(t.targetId)return t.targetId}return(a==null?void 0:a.roleId)||(a==null?void 0:a.id)||(a==null?void 0:a.targetId)},x=a=>{if(!a)return!0;const t=new Date().toDateString(),m=new Date(a*1e3).toDateString();return t!==m},P=()=>{const a=[9904,9905,9901,9902,9903,9904,9905],t=new Date().getDay();return a[t]};class v{constructor(t){this.tokenStore=t}log(t,m="info"){var o;(o=this.callbacks)!=null&&o.onLog&&this.callbacks.onLog({time:new Date().toLocaleTimeString(),message:t,type:m})}async executeGameCommand(t,m,o={},i="",n=8e3){try{i&&this.log(`执行: ${i}`);const r=await this.tokenStore.sendMessageWithPromise(t,m,o,n);return await new Promise(u=>setTimeout(u,500)),i&&this.log(`${i} - 成功`,"success"),r}catch(r){throw i&&this.log(`${i} - 失败: ${r.message}`,"error"),r}}async switchToFormationIfNeeded(t,m,o){var i;try{this.log(`检查${o}配置...`);const n=await this.executeGameCommand(t,"presetteam_getinfo",{},"获取阵容信息"),r=(i=n==null?void 0:n.presetTeamInfo)==null?void 0:i.useTeamId;return this.log(`当前阵容: ${r}`),r===m?(this.log(`当前已是${o}${m}，无需切换`,"success"),!1):(this.log(`当前阵容: ${r}, 目标阵容: ${m}，开始切换...`),await this.executeGameCommand(t,"presetteam_saveteam",{teamId:m},`切换到${o}${m}`),this.log(`成功切换到${o}${m}`,"success"),!0)}catch(n){this.log(`阵容检查失败，尝试强制切换: ${n.message}`,"warning");try{return await this.executeGameCommand(t,"presetteam_saveteam",{teamId:m},`强制切换到${o}${m}`),!0}catch(r){throw this.log(`强制切换也失败: ${r.message}`,"error"),r}}}loadSettings(t){try{const m=localStorage.getItem(`daily-settings:${t}`),o={arenaFormation:1,bossFormation:1,bossTimes:2,claimBottle:!0,payRecruit:!0,openBox:!0,arenaEnable:!0,claimHangUp:!0,claimEmail:!0,blackMarketPurchase:!0};return m?{...o,...JSON.parse(m)}:o}catch(m){return console.error("Failed to load settings:",m),null}}async run(t,m={},o=null){var b,_,C;this.callbacks=m;const i=o||this.loadSettings(t);this.log("正在获取角色信息...");let n;try{n=await this.tokenStore.sendGetRoleInfo(t),this.log("角色信息获取成功","success")}catch(e){throw this.log(`获取角色信息失败: ${e.message}`,"error"),e}const r=n==null?void 0:n.role;if(!r)throw new Error("角色数据不存在");this.log("开始执行每日任务补差");const u=((b=r.dailyTask)==null?void 0:b.complete)??{},h=e=>u[e]===-1,S=r.statistics??{},d=r.statisticsTime??{},s=[];if(h(2)||s.push({name:"分享一次游戏",execute:()=>this.executeGameCommand(t,"system_mysharecallback",{isSkipShareCard:!0,type:2},"分享游戏")}),h(3)||s.push({name:"赠送好友金币",execute:()=>this.executeGameCommand(t,"friend_batch",{},"赠送好友金币")}),h(4)||(s.push({name:"免费招募",execute:()=>this.executeGameCommand(t,"hero_recruit",{recruitType:3,recruitNumber:1},"免费招募")}),i.payRecruit&&s.push({name:"付费招募",execute:()=>this.executeGameCommand(t,"hero_recruit",{recruitType:1,recruitNumber:1},"付费招募")})),!h(6)&&x(d["buy:gold"]))for(let e=0;e<3;e++)s.push({name:`免费点金 ${e+1}/3`,execute:()=>this.executeGameCommand(t,"system_buygold",{buyNum:1},`免费点金 ${e+1}`)});if(!h(5)&&i.claimHangUp){s.push({name:"领取挂机奖励",execute:()=>this.executeGameCommand(t,"system_claimhangupreward",{},"领取挂机奖励")});for(let e=0;e<4;e++)s.push({name:`挂机加钟 ${e+1}/4`,execute:async()=>{await this.executeGameCommand(t,"system_mysharecallback",{isSkipShareCard:!0,type:2},`挂机加钟 ${e+1}`),await new Promise(c=>setTimeout(c,300))}})}if(!h(7)&&i.openBox&&s.push({name:"开启木质宝箱",execute:()=>this.executeGameCommand(t,"item_openbox",{itemId:2001,number:10},"开启木质宝箱10个")}),s.push({name:"停止盐罐计时",execute:()=>this.executeGameCommand(t,"bottlehelper_stop",{},"停止盐罐计时")}),s.push({name:"开始盐罐计时",execute:()=>this.executeGameCommand(t,"bottlehelper_start",{},"开始盐罐计时")}),!h(14)&&i.claimBottle&&s.push({name:"领取盐罐奖励",execute:()=>this.executeGameCommand(t,"bottlehelper_claim",{},"领取盐罐奖励")}),!h(13)&&i.arenaEnable&&s.push({name:"竞技场战斗",execute:async()=>{this.log("开始竞技场战斗流程");const e=new Date().getHours();if(e<8){this.log("当前时间未到8点，跳过竞技场战斗","warning");return}if(e>22){this.log("当前时间已过22点，跳过竞技场战斗","warning");return}await this.switchToFormationIfNeeded(t,i.arenaFormation,"竞技场阵容"),await this.executeGameCommand(t,"arena_startarea",{},"开始竞技场");for(let c=1;c<=3;c++){this.log(`竞技场战斗 ${c}/3`);let l;try{l=await this.executeGameCommand(t,"arena_getareatarget",{},`获取竞技场目标${c}`)}catch(y){this.log(`竞技场战斗${c} - 获取对手失败: ${y.message}`,"error");break}const p=O(l);p?await this.executeGameCommand(t,"fight_startareaarena",{targetId:p},`竞技场战斗${c}`,1e4):this.log(`竞技场战斗${c} - 未找到目标: ${JSON.stringify(l)}`,"warning"),await new Promise(y=>setTimeout(y,1e3))}}}),i.bossTimes>0){let e=S["legion:boss"]??0;x(d["legion:boss"])&&(e=0);const c=Math.max(i.bossTimes-e,0);if(c>0){s.push({name:"军团BOSS阵容检查",execute:()=>this.switchToFormationIfNeeded(t,i.bossFormation,"BOSS阵容")});for(let l=0;l<c;l++)s.push({name:`军团BOSS ${l+1}/${c}`,execute:()=>this.executeGameCommand(t,"fight_startlegionboss",{},`军团BOSS ${l+1}`,12e3)})}}const G=P();s.push({name:"每日BOSS阵容检查",execute:()=>this.switchToFormationIfNeeded(t,i.bossFormation,"BOSS阵容")});for(let e=0;e<3;e++)s.push({name:`每日BOSS ${e+1}/3`,execute:()=>this.executeGameCommand(t,"fight_startboss",{bossId:G},`每日BOSS ${e+1}`,12e3)});const g=[{name:"福利签到",cmd:"system_signinreward"},{name:"俱乐部",cmd:"legion_signin"},{name:"领取每日礼包",cmd:"discount_claimreward"},{name:"领取每日免费奖励",cmd:"collection_claimfreereward"},{name:"领取免费礼包",cmd:"card_claimreward"},{name:"领取永久卡礼包",cmd:"card_claimreward",params:{cardId:4003}}];if(i.claimEmail&&g.push({name:"领取邮件奖励",cmd:"mail_claimallattachment"}),g.forEach(e=>{s.push({name:e.name,execute:()=>this.executeGameCommand(t,e.cmd,e.params||{},e.name)})}),s.push({name:"开始领取珍宝阁礼包",execute:()=>this.executeGameCommand(t,"collection_goodslist",{},"开始领取珍宝阁礼包")}),s.push({name:"领取珍宝阁免费礼包",execute:()=>this.executeGameCommand(t,"collection_claimfreereward",{},"领取珍宝阁免费礼包")}),x(d["artifact:normal:lottery:time"]))for(let e=0;e<3;e++)s.push({name:`免费钓鱼 ${e+1}/3`,execute:()=>this.executeGameCommand(t,"artifact_lottery",{lotteryNumber:1,newFree:!0,type:1},`免费钓鱼 ${e+1}`)});const w=["魏国","蜀国","吴国","群雄"];for(let e=1;e<=4;e++)x(d[`genie:daily:free:${e}`])&&s.push({name:`${w[e-1]}灯神免费扫荡`,execute:()=>this.executeGameCommand(t,"genie_sweep",{genieId:e},`${w[e-1]}灯神免费扫荡`)});for(let e=0;e<3;e++)s.push({name:`领取免费扫荡卷 ${e+1}/3`,execute:()=>this.executeGameCommand(t,"genie_buysweep",{},`领取免费扫荡卷 ${e+1}`)});!h(12)&&i.blackMarketPurchase&&s.push({name:"黑市购买1次物品",execute:()=>{const e=D.value>4e3?"store_purchase":"store_buy";return this.executeGameCommand(t,e,{goodsId:1},"黑市购买1次物品")}});const f=new Date().getDay();if(f===0|f===1|f===3|f===4){const e={0:107};s.push({name:"咸王梦境",execute:()=>this.executeGameCommand(t,"dungeon_selecthero",{battleTeam:e},"咸王梦境")})}f===1&&x(d["genie:daily:free:5"])&&s.push({name:"深海灯神",execute:()=>this.executeGameCommand(t,"genie_sweep",{genieId:5,sweepCnt:1},"深海灯神")});for(let e=1;e<=10;e++)s.push({name:`领取任务奖励${e}`,execute:()=>this.executeGameCommand(t,"task_claimdailypoint",{taskId:e},`领取任务奖励${e}`,5e3)});s.push({name:"领取日常任务奖励",execute:()=>this.executeGameCommand(t,"task_claimdailyreward",{},"领取日常任务奖励")},{name:"领取周常任务奖励",execute:()=>this.executeGameCommand(t,"task_claimweekreward",{},"领取周常任务奖励")});const $=s.length;this.log(`共有 ${$} 个任务待执行`);for(let e=0;e<s.length;e++){const c=s[e];try{await c.execute();const l=Math.floor((e+1)/$*100);(_=this.callbacks)!=null&&_.onProgress&&this.callbacks.onProgress(l),await new Promise(p=>setTimeout(p,500))}catch(l){this.log(`任务执行失败: ${c.name} - ${l.message}`,"error")}}(C=this.callbacks)!=null&&C.onProgress&&this.callbacks.onProgress(100),this.log("所有任务执行完成","success")}}export{v as D};
