import{K as me,I as de,p as O,r as S,L as ve,c as E,a as n,b as l,y as ge,w as m,d as y,i as P,j as D,t as M,F as X,g as K,e as pe,C as we,u as H,l as fe,G as ye}from"./index-DeoopqlN.js";import{D as be}from"./dailyTaskRunner-BkXEAjiS.js";import{_ as _e}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{S as Se}from"./Settings-BKiOZyjZ.js";const Te={class:"batch-daily-tasks"},ke={class:"page-header"},he={class:"actions"},De={class:"token-row"},Le={class:"token-item"},$e={class:"settings-content"},xe={class:"settings-grid"},Ce={class:"setting-item"},Pe={class:"setting-item"},Be={class:"setting-item"},Ue={class:"setting-switches"},Ee={class:"switch-row"},Me={class:"switch-row"},Re={class:"switch-row"},Fe={class:"switch-row"},We={class:"switch-row"},ze={class:"switch-row"},Ne={class:"switch-row"},Oe={class:"modal-actions",style:{"margin-top":"20px","text-align":"right"}},He={key:0,class:"execution-area"},Ae={class:"time"},Ge={class:"message"},Ie={__name:"BatchDailyTasks",setup(Ve){const v=me(),B=de(),q=new be(v),b=O(()=>v.gameTokens),i=S([]),d=S({}),p=S(!1),T=S(!1),R=S(!1),A=S(null),G=S(""),r=ve({arenaFormation:1,bossFormation:1,bossTimes:2,claimBottle:!0,payRecruit:!0,openBox:!0,arenaEnable:!0,claimHangUp:!0,claimEmail:!0,blackMarketPurchase:!0}),I=[1,2,3,4].map(t=>({label:`阵容${t}`,value:t})),Q=[0,1,2,3,4].map(t=>({label:`${t}次`,value:t})),Y=t=>{try{const e=localStorage.getItem(`daily-settings:${t}`),a={arenaFormation:1,bossFormation:1,bossTimes:2,claimBottle:!0,payRecruit:!0,openBox:!0,arenaEnable:!0,claimHangUp:!0,claimEmail:!0,blackMarketPurchase:!0};return e?{...a,...JSON.parse(e)}:a}catch(e){return console.error("Failed to load settings:",e),null}},Z=t=>{A.value=t.id,G.value=t.name;const e=Y(t.id);Object.assign(r,e),R.value=!0},ee=()=>{A.value&&(localStorage.setItem(`daily-settings:${A.value}`,JSON.stringify(r)),B.success(`已保存 ${G.value} 的设置`),R.value=!1)},k=S(null),h=S(0),L=S([]),F=S(null),V=O(()=>{const t=b.value.find(e=>e.id===k.value);return t?t.name:""}),te=O(()=>i.value.length===b.value.length&&b.value.length>0),ae=O(()=>i.value.length>0&&i.value.length<b.value.length),se=t=>{t?i.value=b.value.map(e=>e.id):i.value=[]},ne=t=>{const e=d.value[t];return e==="completed"?"success":e==="failed"?"error":e==="running"?"info":"default"},le=t=>{const e=d.value[t];return e==="completed"?"已完成":e==="failed"?"失败":e==="running"?"执行中":"等待中"},o=t=>{L.value.push(t),ye(()=>{F.value&&(F.value.scrollTop=F.value.scrollHeight)})},j=async(t,e=1e4)=>{const a=Date.now();for(;Date.now()-a<e;){if(v.getWebSocketStatus(t)==="connected")return!0;await new Promise(f=>setTimeout(f,500))}return!1},oe=async()=>{if(i.value.length!==0){p.value=!0,T.value=!1,L.value=[],i.value.forEach(t=>{d.value[t]="waiting"});for(const t of i.value){if(T.value)break;k.value=t,d.value[t]="running",h.value=0;const e=b.value.find(a=>a.id===t);try{o({time:new Date().toLocaleTimeString(),message:`=== 开始重置罐子: ${e.name} ===`,type:"info"}),await W(t),o({time:new Date().toLocaleTimeString(),message:"停止计时...",type:"info"}),await v.sendMessageWithPromise(t,"bottlehelper_stop",{},5e3),await new Promise(a=>setTimeout(a,500)),o({time:new Date().toLocaleTimeString(),message:"开始计时...",type:"info"}),await v.sendMessageWithPromise(t,"bottlehelper_start",{},5e3),d.value[t]="completed",o({time:new Date().toLocaleTimeString(),message:`=== ${e.name} 重置完成 ===`,type:"success"})}catch(a){console.error(a),d.value[t]="failed",o({time:new Date().toLocaleTimeString(),message:`重置失败: ${a.message}`,type:"error"})}h.value=100,await new Promise(a=>setTimeout(a,500))}p.value=!1,k.value=null,B.success("批量重置罐子结束")}},ie=async()=>{if(i.value.length!==0){p.value=!0,T.value=!1,L.value=[],i.value.forEach(t=>{d.value[t]="waiting"});for(const t of i.value){if(T.value)break;k.value=t,d.value[t]="running",h.value=0;const e=b.value.find(a=>a.id===t);try{o({time:new Date().toLocaleTimeString(),message:`=== 开始领取挂机: ${e.name} ===`,type:"info"}),await W(t),o({time:new Date().toLocaleTimeString(),message:"领取挂机奖励",type:"info"}),await v.sendMessageWithPromise(t,"system_claimhangupreward",{},5e3),await new Promise(a=>setTimeout(a,500));for(let a=0;a<4;a++)o({time:new Date().toLocaleTimeString(),message:`挂机加钟 ${a+1}/4`,type:"info"}),await v.sendMessageWithPromise(t,"system_mysharecallback",{isSkipShareCard:!0,type:2},5e3),await new Promise(w=>setTimeout(w,500));o({time:new Date().toLocaleTimeString(),message:"挂机加钟 5/5",type:"info"}),await v.sendMessageWithPromise(t,"system_mysharecallback",{isSkipShareCard:!0,type:2},5e3),d.value[t]="completed",o({time:new Date().toLocaleTimeString(),message:`=== ${e.name} 领取完成 ===`,type:"success"})}catch(a){console.error(a),d.value[t]="failed",o({time:new Date().toLocaleTimeString(),message:`领取失败: ${a.message}`,type:"error"})}h.value=100,await new Promise(a=>setTimeout(a,500))}p.value=!1,k.value=null,B.success("批量领取挂机结束")}},W=async t=>{const e=b.value.find(u=>u.id===t);if(v.getWebSocketStatus(t)!=="connected"){if(o({time:new Date().toLocaleTimeString(),message:"正在连接...",type:"info"}),v.createWebSocketConnection(t,e.token,e.wsUrl),await j(t))return!0;o({time:new Date().toLocaleTimeString(),message:"连接超时，尝试重连...",type:"warning"})}else return!0;v.closeWebSocketConnection(t),await new Promise(u=>setTimeout(u,2e3)),o({time:new Date().toLocaleTimeString(),message:"正在重连...",type:"info"});const w=b.value.find(u=>u.id===t);if(v.createWebSocketConnection(t,w.token,w.wsUrl),!await j(t))throw new Error("连接失败 (重试后仍超时)");return!0},re=async()=>{var t,e,a,w,f,u;if(i.value.length!==0){p.value=!0,T.value=!1,L.value=[],i.value.forEach(g=>{d.value[g]="waiting"});for(const g of i.value){if(T.value)break;k.value=g,d.value[g]="running",h.value=0;const z=b.value.find(c=>c.id===g);try{o({time:new Date().toLocaleTimeString(),message:`=== 开始爬塔: ${z.name} ===`,type:"info"}),await W(g);let c=await v.sendGetRoleInfo(g),C=((e=(t=c==null?void 0:c.role)==null?void 0:t.tower)==null?void 0:e.energy)||0;o({time:new Date().toLocaleTimeString(),message:`初始体力: ${C}`,type:"info"});let $=0;const U=100;let _=0;for(;C>0&&$<U&&!T.value;)try{await v.sendMessageWithPromise(g,"fight_starttower",{},5e3),$++,_=0,o({time:new Date().toLocaleTimeString(),message:`爬塔第 ${$} 次`,type:"info"}),await new Promise(x=>setTimeout(x,1500)),c=await v.sendGetRoleInfo(g),C=((w=(a=c==null?void 0:c.role)==null?void 0:a.tower)==null?void 0:w.energy)||0}catch(x){if(x.message&&x.message.includes("200400")){o({time:new Date().toLocaleTimeString(),message:"爬塔次数已用完 (200400)",type:"info"});break}if(_++,o({time:new Date().toLocaleTimeString(),message:`战斗出错: ${x.message} (重试 ${_}/3)`,type:"warning"}),_>=3){o({time:new Date().toLocaleTimeString(),message:"连续失败次数过多，停止爬塔",type:"error"});break}await new Promise(N=>setTimeout(N,2e3));try{c=await v.sendGetRoleInfo(g),C=((u=(f=c==null?void 0:c.role)==null?void 0:f.tower)==null?void 0:u.energy)||0}catch{}}d.value[g]="completed",o({time:new Date().toLocaleTimeString(),message:`=== ${z.name} 爬塔结束，共 ${$} 次 ===`,type:"success"})}catch(c){console.error(c),d.value[g]="failed",o({time:new Date().toLocaleTimeString(),message:`爬塔失败: ${c.message}`,type:"error"})}h.value=100,await new Promise(c=>setTimeout(c,500))}p.value=!1,k.value=null,B.success("批量爬塔结束")}},ue=async()=>{if(i.value.length!==0){p.value=!0,T.value=!1,L.value=[],i.value.forEach(t=>{d.value[t]="waiting"});for(const t of i.value){if(T.value)break;k.value=t,d.value[t]="running",h.value=0;let e=0;const a=1;let w=!1;for(;e<=a&&!w;){const f=b.value.find(u=>u.id===t);try{o(e===0?{time:new Date().toLocaleTimeString(),message:`=== 开始执行: ${f.name} ===`,type:"info"}:{time:new Date().toLocaleTimeString(),message:`=== 尝试重试: ${f.name} (第${e}次) ===`,type:"info"}),await W(t),await q.run(t,{onLog:u=>o(u),onProgress:u=>{h.value=u}}),w=!0,d.value[t]="completed",o({time:new Date().toLocaleTimeString(),message:`=== ${f.name} 执行完成 ===`,type:"success"})}catch(u){console.error(u),e<a?(o({time:new Date().toLocaleTimeString(),message:`执行出错: ${u.message}，等待3秒后重试...`,type:"warning"}),await new Promise(g=>setTimeout(g,3e3)),e++):(d.value[t]="failed",o({time:new Date().toLocaleTimeString(),message:`执行失败: ${u.message}`,type:"error"}))}}await new Promise(f=>setTimeout(f,1e3))}p.value=!1,k.value=null,B.success("批量任务执行结束")}},ce=()=>{T.value=!0,o({time:new Date().toLocaleTimeString(),message:"正在停止...",type:"warning"})};return(t,e)=>{const a=y("n-button"),w=y("n-space"),f=y("n-checkbox"),u=y("n-tag"),g=y("n-icon"),z=y("n-grid-item"),c=y("n-grid"),C=y("n-checkbox-group"),$=y("n-card"),U=y("n-select"),_=y("n-switch"),x=y("n-modal"),N=y("n-progress");return P(),E("div",Te,[n("div",ke,[e[13]||(e[13]=n("h2",null,"批量日常任务",-1)),n("div",he,[l(a,{type:"primary",onClick:ue,disabled:p.value||i.value.length===0},{default:m(()=>[D(M(p.value?"执行中...":"开始执行"),1)]),_:1},8,["disabled"]),l(a,{onClick:ce,disabled:!p.value,type:"error",style:{"margin-left":"12px"}},{default:m(()=>[...e[12]||(e[12]=[D(" 停止 ",-1)])]),_:1},8,["disabled"])])]),l($,{title:"账号列表",class:"token-list-card"},{"header-extra":m(()=>[l(w,null,{default:m(()=>[l(a,{size:"small",onClick:ie,disabled:p.value||i.value.length===0},{default:m(()=>[...e[14]||(e[14]=[D(" 领取挂机 ",-1)])]),_:1},8,["disabled"]),l(a,{size:"small",onClick:oe,disabled:p.value||i.value.length===0},{default:m(()=>[...e[15]||(e[15]=[D(" 重置罐子 ",-1)])]),_:1},8,["disabled"]),l(a,{size:"small",onClick:re,disabled:p.value||i.value.length===0},{default:m(()=>[...e[16]||(e[16]=[D(" 一键爬塔 ",-1)])]),_:1},8,["disabled"])]),_:1})]),default:m(()=>[l(w,{vertical:""},{default:m(()=>[l(f,{checked:te.value,indeterminate:ae.value,"onUpdate:checked":se},{default:m(()=>[...e[17]||(e[17]=[D(" 全选 ",-1)])]),_:1},8,["checked","indeterminate"]),l(C,{value:i.value,"onUpdate:value":e[0]||(e[0]=s=>i.value=s)},{default:m(()=>[l(c,{"x-gap":12,"y-gap":8,cols:2},{default:m(()=>[(P(!0),E(X,null,K(b.value,s=>(P(),pe(z,{key:s.id},{default:m(()=>[n("div",De,[l(f,{value:s.id,label:s.name,style:{flex:"1"}},{default:m(()=>[n("div",Le,[n("span",null,M(s.name),1),l(u,{size:"small",type:ne(s.id),style:{"margin-left":"8px"}},{default:m(()=>[D(M(le(s.id)),1)]),_:2},1032,["type"])])]),_:2},1032,["value","label"]),l(a,{size:"tiny",circle:"",onClick:we(J=>Z(s),["stop"])},{icon:m(()=>[l(g,null,{default:m(()=>[l(H(Se))]),_:1})]),_:1},8,["onClick"])])]),_:2},1024))),128))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),l(x,{show:R.value,"onUpdate:show":e[11]||(e[11]=s=>R.value=s),preset:"card",title:`任务设置 - ${G.value}`,style:{width:"90%","max-width":"400px"}},{default:m(()=>[n("div",$e,[n("div",xe,[n("div",Ce,[e[18]||(e[18]=n("label",{class:"setting-label"},"竞技场阵容",-1)),l(U,{value:r.arenaFormation,"onUpdate:value":e[1]||(e[1]=s=>r.arenaFormation=s),options:H(I),size:"small"},null,8,["value","options"])]),n("div",Pe,[e[19]||(e[19]=n("label",{class:"setting-label"},"BOSS阵容",-1)),l(U,{value:r.bossFormation,"onUpdate:value":e[2]||(e[2]=s=>r.bossFormation=s),options:H(I),size:"small"},null,8,["value","options"])]),n("div",Be,[e[20]||(e[20]=n("label",{class:"setting-label"},"BOSS次数",-1)),l(U,{value:r.bossTimes,"onUpdate:value":e[3]||(e[3]=s=>r.bossTimes=s),options:H(Q),size:"small"},null,8,["value","options"])]),n("div",Ue,[n("div",Ee,[e[21]||(e[21]=n("span",{class:"switch-label"},"领罐子",-1)),l(_,{value:r.claimBottle,"onUpdate:value":e[4]||(e[4]=s=>r.claimBottle=s)},null,8,["value"])]),n("div",Me,[e[22]||(e[22]=n("span",{class:"switch-label"},"领挂机",-1)),l(_,{value:r.claimHangUp,"onUpdate:value":e[5]||(e[5]=s=>r.claimHangUp=s)},null,8,["value"])]),n("div",Re,[e[23]||(e[23]=n("span",{class:"switch-label"},"竞技场",-1)),l(_,{value:r.arenaEnable,"onUpdate:value":e[6]||(e[6]=s=>r.arenaEnable=s)},null,8,["value"])]),n("div",Fe,[e[24]||(e[24]=n("span",{class:"switch-label"},"开宝箱",-1)),l(_,{value:r.openBox,"onUpdate:value":e[7]||(e[7]=s=>r.openBox=s)},null,8,["value"])]),n("div",We,[e[25]||(e[25]=n("span",{class:"switch-label"},"领取邮件奖励",-1)),l(_,{value:r.claimEmail,"onUpdate:value":e[8]||(e[8]=s=>r.claimEmail=s)},null,8,["value"])]),n("div",ze,[e[26]||(e[26]=n("span",{class:"switch-label"},"黑市购买物品",-1)),l(_,{value:r.blackMarketPurchase,"onUpdate:value":e[9]||(e[9]=s=>r.blackMarketPurchase=s)},null,8,["value"])]),n("div",Ne,[e[27]||(e[27]=n("span",{class:"switch-label"},"付费招募",-1)),l(_,{value:r.payRecruit,"onUpdate:value":e[10]||(e[10]=s=>r.payRecruit=s)},null,8,["value"])])])]),n("div",Oe,[l(a,{type:"primary",onClick:ee},{default:m(()=>[...e[28]||(e[28]=[D("保存设置",-1)])]),_:1})])])]),_:1},8,["show","title"]),k.value||L.value.length>0?(P(),E("div",He,[l($,{title:V.value?`正在执行: ${V.value}`:"执行日志",style:{"margin-top":"16px"}},{default:m(()=>[l(N,{type:"line",percentage:h.value,"indicator-placement":"inside",processing:""},null,8,["percentage"]),n("div",{class:"log-container",ref_key:"logContainer",ref:F},[(P(!0),E(X,null,K(L.value,(s,J)=>(P(),E("div",{key:J,class:fe(["log-item",s.type])},[n("span",Ae,"["+M(s.time)+"]",1),n("span",Ge,M(s.message),1)],2))),128))],512)]),_:1},8,["title"])])):ge("",!0)])}}},qe=_e(Ie,[["__scopeId","data-v-cf71ac29"]]);export{qe as default};
